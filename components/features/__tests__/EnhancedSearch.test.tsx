import { render, screen, waitFor }
from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { EnhancedSearch }
from "../EnhancedSearch";
// Mock next/navigation jest.mock('next/navigation', () => ({ useRouter: () => ({ push: jest.fn(), }), })) // Mock hooks jest.mock('@/lib/hooks/useDebounce', () => ({ useDebounce: (value: string) => value, }))

jest.mock('@/lib/hooks/useSearchHistory', () => ({ useSearchHistory: () => ({ history: [ { id: '1', query: 'React', timestamp: Date.now(), resultCount: 5 }, { id: '2', query: 'TypeScript', timestamp: Date.now(), resultCount: 3 }, ], addToHistory: jest.fn(), removeFromHistory: jest.fn(), clearHistory: jest.fn(), getRecentQueries: () => ['React', 'TypeScript'], getPopularQueries: () => ['React', 'TypeScript'], }), })) // Mock search engine jest.mock('@/lib/search/advancedSearch', () => ({ AdvancedSearch: jest.fn().mockImplementation(() => ({ search: jest.fn().mockReturnValue({ results: [ { id: '1', title: 'React å…¥é—¨æŒ‡å—', content: 'å­¦ä¹  React çš„åŸºç¡€çŸ¥è¯†', type: 'post', url: '/posts/react-guide', category: 'å‰ç«¯å¼€å‘', date: new Date('2024-01-01'), }, { id: '2', title: 'TypeScript æœ€ä½³å®è·µ', content: 'TypeScript å¼€å‘æŠ€å·§', type: 'post', url: '/posts/typescript-tips', category: 'å‰ç«¯å¼€å‘', date: new Date('2024-01-02'), }, ], stats: { totalResults: 2, resultsByType: { post: 2, project: 0, book: 0, tool: 0 }, searchTime: 50, }, }), getSuggestions: jest.fn().mockReturnValue(['React Hooks', 'React Router']), getCategories: jest.fn().mockReturnValue(['å‰ç«¯å¼€å‘', 'åç«¯æŠ€æœ¯']), getTags: jest.fn().mockReturnValue(['React', 'TypeScript', 'JavaScript']), })), })) describe('EnhancedSearch', () => { beforeEach(() => { jest.clearAllMocks() })
it('renders search button with keyboard shortcut', () => { render(<EnhancedSearch />
)
expect(screen.getByText('ğŸ”')).toBeInTheDocument() expect(screen.getByText('æœç´¢')).toBeInTheDocument() expect(screen.getByText('âŒ˜')).toBeInTheDocument() expect(screen.getByText('K')).toBeInTheDocument() })
it('opens search modal when button is clicked', async () => { const user = userEvent.setup() render(<EnhancedSearch />
)
const searchButton = screen.getByRole('button', { name: /æœç´¢/i }) await user.click(searchButton) expect(screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...')).toBeInTheDocument() })
it('opens search modal with Cmd+K keyboard shortcut', async () => { render(<EnhancedSearch />
)
const event = new KeyboardEvent('keydown', { key: 'k', metaKey: true, }) document.dispatchEvent(event) await waitFor(() => { expect(screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...')).toBeInTheDocument() }) })
it('closes search modal with Escape key', async () => { const user = userEvent.setup() render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i })) expect(screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...')).toBeInTheDocument() const event = new KeyboardEvent('keydown', { key: 'Escape' }) document.dispatchEvent(event) await waitFor(() => { expect(screen.queryByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...')).not.toBeInTheDocument() }) })
it('displays search history when input is focused', async () => { const user = userEvent.setup() render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i }))

const input = screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...') await user.click(input) expect(screen.getByText('æœç´¢å†å²')).toBeInTheDocument() expect(screen.getByText('React')).toBeInTheDocument() expect(screen.getByText('TypeScript')).toBeInTheDocument() expect(screen.getByText('(5 ç»“æœ)')).toBeInTheDocument() expect(screen.getByText('(3 ç»“æœ)')).toBeInTheDocument() })
it('clears search history when clear button is clicked', async () => { const user = userEvent.setup() const { useSearchHistory } = require('@/lib/hooks/useSearchHistory') const clearHistory = jest.fn() useSearchHistory.mockReturnValue({ history: [{ id: '1', query: 'React', timestamp: Date.now(), resultCount: 5 }
], clearHistory, addToHistory: jest.fn(), removeFromHistory: jest.fn(), getRecentQueries: () => [], }) render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i })) await user.click(screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...')) const clearButton = screen.getByText('æ¸…é™¤') await user.click(clearButton) expect(clearHistory).toHaveBeenCalled() })
it('performs search and displays results', async () => { const user = userEvent.setup() render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i }))

const input = screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...') await user.type(input, 'React') await waitFor(() => { expect(screen.getByText('React å…¥é—¨æŒ‡å—')).toBeInTheDocument() expect(screen.getByText('å­¦ä¹  React çš„åŸºç¡€çŸ¥è¯†')).toBeInTheDocument() expect(screen.getByText('TypeScript æœ€ä½³å®è·µ')).toBeInTheDocument() expect(screen.getByText('TypeScript å¼€å‘æŠ€å·§')).toBeInTheDocument() }) })
it('displays search suggestions while typing', async () => { const user = userEvent.setup() render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i }))

const input = screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...') await user.type(input, 'Re') await waitFor(() => { expect(screen.getByText('æœç´¢å»ºè®®')).toBeInTheDocument() expect(screen.getByText('React Hooks')).toBeInTheDocument() expect(screen.getByText('React Router')).toBeInTheDocument() }) })
it('filters search results by type', async () => { const user = userEvent.setup() const { AdvancedSearch } = require('@/lib/search/advancedSearch') const mockSearch = jest.fn().mockReturnValue({ results: [ { id: '1', title: 'Project Alpha', content: 'A great project', type: 'project', url: '/projects/alpha', }, ], stats: { totalResults: 1, resultsByType: { post: 0, project: 1, book: 0, tool: 0 }, searchTime: 30 }, }) AdvancedSearch.mockImplementation(() => ({ search: mockSearch, getSuggestions: jest.fn().mockReturnValue([]), getCategories: jest.fn().mockReturnValue([]), })) render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i }))

const projectButton = screen.getByRole('button', { name: 'é¡¹ç›®' }) await user.click(projectButton) await waitFor(() => { expect(mockSearch).toHaveBeenCalledWith( expect.objectContaining({ filters: expect.objectContaining({ type: 'project' }), }) ) }) })
it('toggles advanced filters panel', async () => { const user = userEvent.setup() render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i })) expect(screen.queryByText('åˆ†ç±»ï¼š')).not.toBeInTheDocument() const filterButton = screen.getByRole('button', { name: /é«˜çº§ç­›é€‰/i }) await user.click(filterButton) expect(screen.getByText('åˆ†ç±»ï¼š')).toBeInTheDocument() expect(screen.getByText('æ—¶é—´ï¼š')).toBeInTheDocument() })
it('filters by date range preset', async () => { const user = userEvent.setup() const { AdvancedSearch } = require('@/lib/search/advancedSearch') const mockSearch = jest.fn().mockReturnValue({ results: [], stats: {}
}) AdvancedSearch.mockImplementation(() => ({ search: mockSearch, getSuggestions: jest.fn().mockReturnValue([]), getCategories: jest.fn().mockReturnValue([]), })) render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i })) await user.click(screen.getByRole('button', { name: /é«˜çº§ç­›é€‰/i }))

const weekButton = screen.getByRole('button', { name: 'æœ¬å‘¨' }) await user.click(weekButton) await waitFor(() => { expect(mockSearch).toHaveBeenCalledWith( expect.objectContaining({ filters: expect.objectContaining({ dateRange: { preset: 'week' }, }), }) ) }) })
it('navigates to result when clicked', async () => { const user = userEvent.setup() const { useRouter } = require('next/navigation') const push = jest.fn() useRouter.mockReturnValue({ push }) render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i })) await user.type(screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...'), 'React') await waitFor(() => { expect(screen.getByText('React å…¥é—¨æŒ‡å—')).toBeInTheDocument() }) await user.click(screen.getByText('React å…¥é—¨æŒ‡å—')) expect(push).toHaveBeenCalledWith('/posts/react-guide') })
it('shows no results message when search returns empty', async () => { const user = userEvent.setup() const { AdvancedSearch } = require('@/lib/search/advancedSearch') AdvancedSearch.mockImplementation(() => ({ search: jest.fn().mockReturnValue({ results: [], stats: {}
}), getSuggestions: jest.fn().mockReturnValue([]), getCategories: jest.fn().mockReturnValue([]), })) render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i })) await user.type(screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...'), 'xyz') await waitFor(() => { expect(screen.getByText('æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å†…å®¹')).toBeInTheDocument() }) })
it('displays result count in footer', async () => { const user = userEvent.setup() render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i })) await user.type(screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...'), 'React') await waitFor(() => { expect(screen.getByText('å…± 2 ä¸ªç»“æœ')).toBeInTheDocument() }) })
it('removes individual history item', async () => { const user = userEvent.setup() const { useSearchHistory } = require('@/lib/hooks/useSearchHistory') const removeFromHistory = jest.fn() useSearchHistory.mockReturnValue({ history: [{ id: '1', query: 'React', timestamp: Date.now(), resultCount: 5 }
], removeFromHistory, clearHistory: jest.fn(), addToHistory: jest.fn(), getRecentQueries: () => [], }) render(<EnhancedSearch />) await user.click(screen.getByRole('button', { name: /æœç´¢/i })) await user.click(screen.getByPlaceholderText('æœç´¢æ–‡ç« ã€é¡¹ç›®ã€ä¹¦ç±ã€å·¥å…·...')) const removeButton = screen.getByText('âœ•') await user.click(removeButton) expect(removeFromHistory).toHaveBeenCalledWith('1') }) })
