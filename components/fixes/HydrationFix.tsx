/** * HydrationFix - ç¡®ä¿å®¢æˆ·ç«¯æ­£ç¡®hydration * * è§£å†³Next.js 15 + React 18çš„hydrationå’Œäº‹ä»¶å§”æ‰˜é—®é¢˜ */ 'use client' import { useEffect }
from 'react' 

import { useRouter }
from 'next/navigation' export function HydrationFix() { const router = useRouter() useEffect(() => { // åªåœ¨å®¢æˆ·ç«¯è¿è¡Œ if (typeof window === 'undefined') return console.log('ðŸ’§ HydrationFix: å¼€å§‹ä¿®å¤hydrationé—®é¢˜') // 1. ç¡®ä¿Reactå·²å®Œæˆhydration const checkHydration = () => { const reactRoot = document.getElementById('__next') if (reactRoot && !reactRoot.hasAttribute('data-hydration-fixed')) { // æ ‡è®°hydrationå·²ä¿®å¤ reactRoot.setAttribute('data-hydration-fixed', 'true') // 2. å¼ºåˆ¶è§¦å‘ä¸€æ¬¡å¾®å°çš„DOMæ›´æ–° requestAnimationFrame(() => { document.body.classList.add('hydrated') // 3. ç¡®ä¿Next.jsè·¯ç”±ç³»ç»Ÿå·²å‡†å¤‡å¥½ router.prefetch(window.location.pathname) // 4. åˆ†å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç»„ä»¶ window.dispatchEvent(new CustomEvent('hydrationComplete')) console.log('ðŸ’§ HydrationFix: Hydrationä¿®å¤å®Œæˆ') }) }
}
// 5. ä½¿ç”¨å¤šç§æ—¶æœºç¡®ä¿ä¿®å¤æˆåŠŸ // ç«‹å³æ‰§è¡Œ checkHydration() // DOMå†…å®¹åŠ è½½å®ŒæˆåŽ if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', checkHydration) }
// é¡µé¢å®Œå…¨åŠ è½½åŽ window.addEventListener('load', checkHydration) // Reactå¯èƒ½çš„å¼‚æ­¥æ¸²æŸ“å®ŒæˆåŽ const timer = setTimeout(checkHydration, 0) // 6. ä¿®å¤å¯èƒ½çš„äº‹ä»¶å§”æ‰˜é—®é¢˜ const fixEventDelegation = () => { // èŽ·å–æ‰€æœ‰Next.js Linkç»„ä»¶æ¸²æŸ“çš„é“¾æŽ¥ const links = document.querySelectorAll('a[href^="/"]') links.forEach(link => { // ç¡®ä¿é“¾æŽ¥æœ‰æ­£ç¡®çš„äº‹ä»¶å¤„ç† if (!link.hasAttribute('data-event-fixed')) { link.setAttribute('data-event-fixed', 'true') // å¦‚æžœç‚¹å‡»æ— æ•ˆï¼Œæ·»åŠ å¤‡ç”¨å¤„ç† link.addEventListener('click', (e) => { // æ£€æŸ¥æ˜¯å¦å·²è¢«Next.jså¤„ç† if (!e.defaultPrevented && link instanceof HTMLAnchorElement) { const href = link.getAttribute('href') if (href && href.startsWith('/')) { console.log('ðŸ’§ HydrationFix: ä½¿ç”¨å¤‡ç”¨å¯¼èˆª', href) e.preventDefault() router.push(href) }
} }, { capture: false, passive: false }) }
}) }
// å»¶è¿Ÿæ‰§è¡Œäº‹ä»¶ä¿®å¤ const eventTimer = setTimeout(fixEventDelegation, 100) // æ¸…ç† return () => { clearTimeout(timer) clearTimeout(eventTimer) document.removeEventListener('DOMContentLoaded', checkHydration) window.removeEventListener('load', checkHydration) }
}, [router]) return null }